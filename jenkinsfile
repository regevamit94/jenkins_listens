pipeline {
    agent any
    parameters {
        choice(
            name: 'SSH_CREDENTIALS_ID',
            choices: ['3861a10a-9cb6-419e-8405-c7a26dbfeace'], // Add your SSH credentials IDs here
            description: 'Select SSH credentials ID:'
        )
    }
     environment {
       CLUSTERNAME = 'test'
       HOME = "${HOME}"
       TARGETDIRECTORY = "${HOME}/imjenkinsslave/"
    }  

    stages {
        stage('Check if Cluster exists') {
            steps {
                script {
                    def statusCode = sh(script: "kind get clusters | grep -w $CLUSTERNAME", returnStatus: true)
                    if (statusCode == '1') {
                        error "Kubernetes cluster '$CLUSTERNAME' is running!"
                    } else {
                        echo "Kubernetes cluster '$CLUSTERNAME' is not running. It will be created now."
                        sshagent(credentials: [params.SSH_CREDENTIALS_ID]) {
                        sh(script:"scp -i $HOME/.ssh/id_rsa -o StrictHostKeyChecking=no your-yaml-file.yaml $SSH_CREDENTIALS_ID@${env.NODE_NAME}:$TARGETDIRECTORY")
                    }
                        sh(script:"kind create cluster --name $CLUSTERNAME --image kindest/node:v1.23.6 --config $TARGETDIRECTORY/kind.yaml")
                }
            }
        }
    }
  } 
}
